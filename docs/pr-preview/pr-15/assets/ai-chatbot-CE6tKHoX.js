import{r as Ct,i as Mt,x as _,E as It}from"./iframe-4E2mj6Mt.js";import{t as wt}from"./custom-element-UsVr97OX.js";import{n as p}from"./property-dr-OOLCt.js";import{n as P,e as D}from"./ref-ergCtqT6.js";import{n as O}from"./when-CI7b_ccM.js";import{S as $t}from"./mock-adapter-MuFwfiLK.js";import{g as T,d as Tt}from"./utils-C_XXmvvR.js";import"./ai-attachment-DMZa3I0D.js";import"./ai-chat-header-CfaSc-Wg.js";import"./ai-chat-interface-DDEnn1H8.js";import"./ai-file-picker-DATO6yBL.js";import"./ai-message-thread-CGeuZFWU.js";import"./ai-prompt-C-lnM2Er.js";import"./ai-suggestions-C_yg7vcg.js";import"./ai-voice-input-B-Cd2Hdn.js";import"./tooltip-ti1qEjTn.js";class vt{constructor(t){this._attachments=new Map,this._abortCallbacks=new Map,this._config=t}get pendingAttachments(){return Array.from(this._attachments.values()).filter(t=>t.status==="pending"||t.status==="uploading").map(t=>t.metadata)}get allAttachments(){return Array.from(this._attachments.values()).map(t=>t.metadata)}get isUploading(){return Array.from(this._attachments.values()).some(t=>t.status==="uploading")}updateConfig(t){this._config={...this._config,...t}}addAttachment(t,a){const s={id:t,status:"pending",...a};this._attachments.set(t,{id:t,metadata:s,status:"pending"}),this._config.onStateChange?.()}removeAttachment(t){this._attachments.delete(t),this._abortCallbacks.delete(t),this._config.onStateChange?.()}updateProgress(t,a){const s=this._attachments.get(t);s&&(s.status="uploading",s.metadata.uploading=!0,s.metadata.progress=a,s.metadata.status="uploading",this._config.onStateChange?.())}markComplete(t,a){const s=this._attachments.get(t);s&&(s.status="complete",s.uploadedFile=a,s.metadata.uploading=!1,s.metadata.progress=100,s.metadata.status="success",this._config.onStateChange?.())}markError(t,a){const s=this._attachments.get(t);s&&(s.status="error",s.errorMessage=a,s.metadata.uploading=!1,s.metadata.status="error",s.metadata.error=a,console.error(`File upload error for ${s.metadata.filename}: ${a}`),this._config.onError?.(a),this.removeAttachment(t))}registerOnAbort(t,a){this._abortCallbacks.set(t,a)}abort(t){const a=this._abortCallbacks.get(t);a&&a(),this.removeAttachment(t)}canSend(){return!Array.from(this._attachments.values()).some(t=>t.status==="uploading")}getCompletedUploads(){return Array.from(this._attachments.values()).filter(t=>t.status==="complete"&&t.uploadedFile).map(t=>t.uploadedFile)}consumeAttachments(){const t=Array.from(this._attachments.values()).map(a=>a.metadata);return this._attachments.clear(),this._abortCallbacks.clear(),this._config.onStateChange?.(),t}clear(){this._attachments.clear(),this._abortCallbacks.clear(),this._config.onStateChange?.()}}class xt{constructor(t,a){this._host=t,this._config=a,this._messageItems=[],this._toolCalls=new Map,t.addController(this)}hostConnected(){}hostDisconnected(){this._messageItems=[],this._toolCalls.clear()}updateConfig(t){this._config={...this._config,...t}}get messageItems(){return this._messageItems}getToolCall(t){return this._toolCalls.get(t)}#t(){this._host.requestUpdate()}addMessageItem(t){this._messageItems=[...this._messageItems,t],this.#t()}addMessage(t){this.getMessage(t.id)||this.addMessageItem({type:"message",data:t})}addToolCall(t){this._toolCalls.set(t.id,t),this.addMessageItem({type:"toolCall",data:t})}updateToolCall(t,a){const s=this._toolCalls.get(t);if(!s)return;const r={...s,...a};this._toolCalls.set(t,r),this._messageItems=this._messageItems.map(h=>h.type==="toolCall"&&h.data.id===t?{...h,data:r}:h),this.#t()}appendToMessage(t,a){this._messageItems=this._messageItems.map(s=>s.type==="message"&&s.data.id===t?{...s,data:{...s.data,content:s.data.content+a}}:s),this.#t()}getMessage(t){const a=this._messageItems.find(s=>s.type==="message"&&s.data.id===t);return a?.type==="message"?a.data:void 0}updateMessageStatus(t,a){this._messageItems=this._messageItems.map(s=>s.type==="message"&&s.data.id===t?{...s,data:{...s.data,status:a}}:s),this.#t()}removeMessageItem(t){this._messageItems=this._messageItems.filter((a,s)=>s!==t),this.#t()}clearMessages(){this._messageItems=[],this._toolCalls.clear(),this.#t()}getMessages(){const t=new Map,a=[];for(const s of this._messageItems)if(s.type==="message"){const r={...s.data,toolCalls:[]};t.set(r.id,r),a.push(r.id)}for(const s of this._messageItems)if(s.type==="toolCall"){const r=t.get(s.data.messageId);r&&(r.toolCalls=[...r.toolCalls||[],s.data])}return a.map(s=>t.get(s)).filter(s=>s!==void 0)}setMessages(t){const a=[];this._toolCalls.clear();for(const s of t)if(a.push({type:"message",data:{...s,toolCalls:void 0}}),s.toolCalls)for(const r of s.toolCalls)a.push({type:"toolCall",data:r}),this._toolCalls.set(r.id,r);this._messageItems=a,this.#t()}completeToolCall(t,a){this.updateToolCall(t,{result:a,status:"complete"}),this.#e(t)}#e(t){const a=this._toolCalls.get(t);if(!a)return;const s=this._messageItems.findIndex(I=>I.type==="message"&&I.data.id===a.messageId);if(s===-1)return;const r=this._messageItems[s];if(r.type!=="message"||r.data.content.trim())return;const h=this._messageItems.findIndex(I=>I.type==="toolCall"&&I.data.id===t);if(h===-1||h<=s)return;const[f]=this._messageItems.splice(s,1);this._messageItems.splice(h,0,f),this.#t()}removeUploadedFile(t){this._messageItems=this._messageItems.map(a=>a.type==="message"&&a.data.uploadedFiles?{...a,data:{...a.data,uploadedFiles:a.data.uploadedFiles.filter(s=>s.fileId!==t)}}:a),this.#t()}}const At=":host{display:block;width:100%;height:100%}forge-ai-chat-interface::part(messages){overflow:hidden}forge-ai-chat-interface forge-ai-message-thread{min-height:0}";var St=Object.defineProperty,kt=Object.getOwnPropertyDescriptor,W=e=>{throw TypeError(e)},m=(e,t,a,s)=>{for(var r=s>1?void 0:s?kt(t,a):t,h=e.length-1,f;h>=0;h--)(f=e[h])&&(r=(s?f(t,a,r):f(r))||r);return s&&r&&St(t,a,r),r},F=(e,t,a)=>t.has(e)||W("Cannot "+a),o=(e,t,a)=>(F(e,t,"read from private field"),a?a.call(e):t.get(e)),u=(e,t,a)=>t.has(e)?W("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,a),C=(e,t,a,s)=>(F(e,t,"write to private field"),t.set(e,a),a),n=(e,t,a)=>(F(e,t,"access private method"),a),w,$,l,d,b,M,i,v,x,q,k,y,E,A,N,H,L,G,V,U,Y,J,K,Q,X,Z,R,z,j,S,tt,et,st,at,it,B,ot,nt,rt,lt,ht,dt,ct,gt,mt,pt,ft,ut,_t,bt,yt,g;const Et="forge-ai-chatbot";let c=class extends Mt{constructor(){super(...arguments),u(this,i),this.fileUpload="off",this.voiceInput="on",this.placeholder="Ask a question...",this.showExpandButton=!1,this.showMinimizeButton=!1,this.expanded=!1,this.minimizeIcon="default",this.enableReactions=!1,this.titleText="AI Assistant",this.headingLevel=2,u(this,w,D()),u(this,$,D()),u(this,l),u(this,d),u(this,b),u(this,M)}connectedCallback(){super.connectedCallback(),C(this,l,new xt(this,{tools:o(this,i,y)})),C(this,d,new vt({onError:e=>{n(this,i,g).call(this,{type:"forge-ai-chatbot-error",detail:{error:e}})},onStateChange:()=>{this.requestUpdate()}})),this.adapter&&n(this,i,E).call(this)}disconnectedCallback(){super.disconnectedCallback(),o(this,M)?.unsubscribe(),this.adapter?.disconnect()}willUpdate(e){e.has("adapter")&&this.adapter&&(C(this,b,void 0),n(this,i,E).call(this))}clearMessages(){o(this,l).clearMessages(),o(this,d).clear()}getMessages(){return o(this,l).getMessages()}setMessages(e){o(this,l).setMessages(e)}async sendMessage(e,t){if(!this.adapter){console.warn("No adapter configured.");return}if(t){const a=Date.now();for(const s of t)n(this,i,B).call(this,s,a)}await n(this,i,z).call(this,{content:e,attachments:o(this,d).pendingAttachments})}abort(){n(this,i,S).call(this)}getThreadState(){return{threadId:this.adapter?.threadId,messages:this.getMessages(),timestamp:Date.now()}}setThreadState(e){this.setMessages(e.messages),e.threadId&&this.adapter&&(this.adapter.threadId=e.threadId)}render(){return _`
      <forge-ai-chat-interface
        ${P(o(this,w))}
        role="region"
        aria-label="AI chatbot"
        aria-live="polite"
        aria-busy=${o(this,i,x)}>
        <forge-ai-chat-header
          slot="header"
          ?show-expand-button=${this.showExpandButton}
          ?show-minimize-button=${this.showMinimizeButton}
          ?expanded=${this.expanded}
          export-option=${o(this,i,k)?"enabled":"off"}
          clear-option=${o(this,i,k)?"enabled":"off"}
          .minimizeIcon=${this.minimizeIcon}
          .agentInfo=${this.agentInfo}
          .headingLevel=${this.headingLevel}
          .titleText=${this.titleText}
          @forge-ai-chat-header-expand=${n(this,i,gt)}
          @forge-ai-chat-header-minimize=${n(this,i,mt)}
          @forge-ai-chat-header-clear=${n(this,i,pt)}
          @forge-ai-chat-header-export=${n(this,i,ut)}
          @forge-ai-chat-header-info=${n(this,i,ft)}>
        </forge-ai-chat-header>
        ${o(this,i,yt)} ${o(this,i,bt)}
      </forge-ai-chat-interface>
    `}};w=new WeakMap;$=new WeakMap;l=new WeakMap;d=new WeakMap;b=new WeakMap;M=new WeakMap;i=new WeakSet;v=function(){return o(this,l)?.messageItems??[]};x=function(){return this.adapter?.isRunning??!1};q=function(){return o(this,d)?.isUploading??!1};k=function(){return o(this,i,v).length>0};y=function(){return o(this,b)||C(this,b,new Map(this.adapter?.getTools().map(e=>[e.name,e])??[])),o(this,b)};E=async function(){!this.adapter||this.adapter.isConnecting||(await this.adapter.connect(),o(this,M)?.unsubscribe(),C(this,M,new $t),o(this,M).add(this.adapter.onMessageStart(n(this,i,A).bind(this)),this.adapter.onMessageDelta(n(this,i,N).bind(this)),this.adapter.onMessageEnd(n(this,i,H).bind(this)),this.adapter.onToolCallStart(n(this,i,L).bind(this)),this.adapter.onToolCallArgs(n(this,i,G).bind(this)),this.adapter.onToolCallEnd(n(this,i,V).bind(this)),this.adapter.onToolCall(n(this,i,Y).bind(this)),this.adapter.onToolCallResult(n(this,i,Z).bind(this)),this.adapter.onRunAborted(n(this,i,Q).bind(this)),this.adapter.onError(n(this,i,K).bind(this)),this.adapter.onStateChange(n(this,i,X).bind(this))),C(this,b,void 0),o(this,l)?.updateConfig({tools:o(this,i,y)}),n(this,i,g).call(this,{type:"forge-ai-chatbot-connected"}))};A=function(e){const t={id:e.messageId,role:"assistant",content:"",timestamp:Date.now(),status:"streaming"};o(this,l).addMessage(t)};N=function(e){if(!o(this,l).getMessage(e.messageId)){n(this,i,A).call(this,{messageId:e.messageId});return}o(this,l).appendToMessage(e.messageId,e.delta),o(this,w).value?.scrollToBottom()};H=function(e){o(this,l).updateMessageStatus(e.messageId,"complete");const t=o(this,l).getMessage(e.messageId);t&&n(this,i,g).call(this,{type:"forge-ai-chatbot-message-received",detail:{message:t}})};L=function(e){o(this,l).getMessage(e.messageId)||n(this,i,A).call(this,{messageId:e.messageId});const a={id:e.id,messageId:e.messageId,name:e.name,args:{},argsBuffer:"",status:"parsing",type:o(this,i,y).has(e.name)?"client":"agent"};o(this,l).addToolCall(a)};G=function(e){o(this,l).updateToolCall(e.id,{argsBuffer:e.argsBuffer,args:e.partialArgs??{}}),o(this,w).value?.scrollToBottom()};V=function(e){o(this,l).updateToolCall(e.id,{args:e.args,argsBuffer:void 0,status:"executing"})};U=function({metadata:e}={}){return{metadata:e,success:!0}};Y=async function(e){o(this,l).getMessage(e.messageId)||n(this,i,A).call(this,{messageId:e.messageId});let a=o(this,l).getToolCall(e.id);if(a?o(this,l).updateToolCall(e.id,{args:e.args,status:"executing"}):(a={id:e.id,messageId:e.messageId,name:e.name,args:e.args,status:"executing",type:o(this,i,y).has(e.name)?"client":"agent"},o(this,l).addToolCall(a)),a?.type==="client"){n(this,i,g).call(this,{type:"forge-ai-chatbot-tool-call",detail:{toolCallId:e.id,toolName:e.name,arguments:e.args}});const s=o(this,i,y).get(e.name);s?.handler?await Promise.resolve(n(this,i,J).call(this,e.id,e.name,s.handler,e.args)):n(this,i,R).call(this,e.id,n(this,i,U).call(this))}};J=async function(e,t,a,s){try{const h=await a({args:s,toolCallId:e,toolName:t,signal:void 0});await n(this,i,R).call(this,e,n(this,i,U).call(this,{metadata:h}))}catch(r){o(this,l).updateToolCall(e,{status:"error",result:{error:r.message}})}};K=function(e){const t={id:T("msg"),role:"assistant",content:e.message,timestamp:Date.now(),status:"error"};o(this,l).addMessage(t),n(this,i,g).call(this,{type:"forge-ai-chatbot-error",detail:{error:e.message}})};Q=function(){const e={id:T("msg"),role:"system",content:"Run cancelled",timestamp:Date.now(),status:"complete"};o(this,l).addMessage(e)};X=function(e){this.requestUpdate()};Z=function(e){o(this,l).completeToolCall(e.toolCallId,e.result),o(this,l).addMessage(e.message)};R=async function(e,t){!o(this,l).getToolCall(e)||!this.adapter||(o(this,l).completeToolCall(e,t),this.adapter.sendToolResult(e,t,this.getMessages()))};z=async function(e){if(!e.content.trim()||!this.adapter||o(this,i,x)){this.adapter||console.warn("No adapter configured.");return}if(!o(this,d).canSend())return;const t=e.attachments??[],a=o(this,d).getCompletedUploads(),s={id:T("msg"),role:"user",content:e.content,timestamp:e.timestamp??Date.now(),status:"pending",attachments:t,uploadedFiles:a};o(this,l).addMessage(s),n(this,i,g).call(this,{type:"forge-ai-chatbot-message-sent",detail:{message:s}}),o(this,d).consumeAttachments();try{this.adapter.sendMessage(this.getMessages()),o(this,l).updateMessageStatus(s.id,"complete")}catch(r){o(this,l).updateMessageStatus(s.id,"error");const h=r instanceof Error?r.message:"Failed to send message";n(this,i,g).call(this,{type:"forge-ai-chatbot-error",detail:{error:h}})}};j=async function(e){const t=[...o(this,d).pendingAttachments];await n(this,i,z).call(this,{content:e.detail.value,timestamp:e.detail.date.getTime(),attachments:t})};S=function(){this.adapter?.isRunning&&this.adapter.abort(),this.requestUpdate()};tt=function(){n(this,i,S).call(this)};et=async function(e){const t=e.detail.messageItemIndex,a=o(this,i,v)[t];if(!(!a||a.type!=="message"))try{await navigator.clipboard.writeText(a.data.content)}catch{}};st=function(e){if(!this.adapter)return;const t=e.detail.messageItemIndex;let a=-1;for(let s=t-1;s>=0;s--){const r=o(this,i,v)[s];if(r.type==="message"&&r.data.role==="user"){a=s;break}}a!==-1&&(o(this,l).removeMessageItem(t),this.adapter.sendMessage(this.getMessages()))};at=function(e){console.warn("thumbs-up",e.detail.messageId)};it=function(e){console.warn("thumbs-down",e.detail.messageId)};B=function(e,t,a){const s=T("file");o(this,d).addAttachment(s,{filename:e.name,size:e.size,mimeType:e.type,timestamp:t,thumbnail:a});const r=n(this,i,nt).call(this,s);this.adapter?.emitFileUpload(e,r),n(this,i,g).call(this,{type:"forge-ai-chatbot-file-select",detail:{fileId:s,file:e,filename:e.name,size:e.size,mimeType:e.type,timestamp:t,thumbnail:a,...r}})};ot=function(e){const{file:t,timestamp:a,thumbnail:s}=e.detail;n(this,i,B).call(this,t,a,s)};nt=function(e){return{updateProgress:t=>{o(this,d).updateProgress(e,t)},markComplete:t=>{o(this,d).markComplete(e,t)},markError:t=>{o(this,d).markError(e,t)},onAbort:t=>{o(this,d).registerOnAbort(e,t)}}};rt=function(e){const t={id:T("msg"),role:"assistant",content:e.detail.message,timestamp:Date.now(),status:"error"};o(this,l).addMessage(t)};lt=function(e){const{filename:t}=e.detail,a=o(this,d).pendingAttachments.find(r=>r.filename===t);if(a){o(this,d).abort(a.id);return}const s=this.getMessages();for(const r of s)if(r.uploadedFiles){const h=r.uploadedFiles.find(f=>f.fileName===t);if(h){n(this,i,ht).call(this,h.fileId);return}}};ht=function(e){if(!this.adapter)return;const t={onSuccess:()=>{o(this,l).removeUploadedFile(e),this.requestUpdate()},onError:a=>{n(this,i,g).call(this,{type:"forge-ai-chatbot-error",detail:{error:a}})}};this.adapter.emitFileRemove(e,t),n(this,i,g).call(this,{type:"forge-ai-chatbot-file-remove",detail:{fileId:e}})};dt=function(e){this.sendMessage(e.detail.text)};ct=function(e){const{transcript:t}=e.detail;t&&o(this,$).value&&(o(this,$).value.value=t)};gt=function(){n(this,i,g).call(this,{type:"forge-ai-chatbot-expand"})};mt=function(){n(this,i,g).call(this,{type:"forge-ai-chatbot-minimize"})};pt=function(){n(this,i,g).call(this,{type:"forge-ai-chatbot-clear",cancelable:!0}).defaultPrevented||this.clearMessages()};ft=function(){n(this,i,g).call(this,{type:"forge-ai-chatbot-info"})};ut=function(){const e=this.getMessages();if(e.length===0)return;const t=e.map(s=>{const r=new Date(s.timestamp).toLocaleString(),h=s.role==="user"?"You":"Assistant";return`[${r}] ${h}:
${s.content}
`}).join(`
`),a=`chat-history-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.txt`;Tt(t,a,"text/plain")};_t=function(){const e=o(this,d).allAttachments;return e.length===0?It:_`
      ${e.map(t=>_`
          <forge-ai-attachment
            slot="attachments"
            .filename=${t.filename}
            .size=${t.size}
            .mimeType=${t.mimeType}
            .thumbnail=${t.thumbnail??""}
            ?uploading=${t.uploading}
            .progress=${t.progress}
            removable
            @forge-ai-attachment-remove=${n(this,i,lt)}>
          </forge-ai-attachment>
        `)}
    `};bt=function(){const e=o(this,i,q);return _`
      <forge-ai-prompt
        ${P(o(this,$))}
        slot="prompt"
        .placeholder=${this.placeholder}
        .running=${o(this,i,x)||e}
        ?disabled=${e}
        @forge-ai-prompt-send=${n(this,i,j)}
        @forge-ai-prompt-stop=${n(this,i,S)}
        @forge-ai-prompt-cancel=${n(this,i,tt)}>
        ${o(this,i,_t)}
        ${O(this.fileUpload==="on",()=>_`
            <forge-ai-file-picker
              slot="actions"
              variant="icon-button"
              multiple
              ?disabled=${e}
              .selectedFiles=${o(this,d).pendingAttachments.map(t=>t.filename)}
              @forge-ai-file-picker-change=${n(this,i,ot)}
              @forge-ai-file-picker-error=${n(this,i,rt)}>
            </forge-ai-file-picker>
          `)}
        ${O(this.voiceInput==="on",()=>_`
            <forge-ai-voice-input slot="actions" @forge-ai-voice-input-result=${n(this,i,ct)}>
            </forge-ai-voice-input>
          `)}
      </forge-ai-prompt>
    `};yt=function(){return _`
      <forge-ai-message-thread
        .messageItems=${o(this,i,v)}
        .tools=${o(this,i,y)}
        ?enable-reactions=${this.enableReactions}
        ?show-thinking=${o(this,i,x)}
        @forge-ai-message-thread-copy=${n(this,i,et)}
        @forge-ai-message-thread-refresh=${n(this,i,st)}
        @forge-ai-message-thread-thumbs-up=${n(this,i,at)}
        @forge-ai-message-thread-thumbs-down=${n(this,i,it)}>
        <slot name="empty-state-heading" slot="empty-state-heading"></slot>
        <slot name="empty-state-message" slot="empty-state-message"></slot>
        <forge-ai-suggestions
          slot="empty-state-actions"
          variant="block"
          .suggestions=${this.suggestions??[]}
          @forge-ai-suggestions-select=${n(this,i,dt)}>
        </forge-ai-suggestions>
      </forge-ai-message-thread>
    `};g=function(e){const t=new CustomEvent(e.type,{detail:e.detail,bubbles:!0,composed:!0,cancelable:e.cancelable??!1});return this.dispatchEvent(t),t};c.styles=Ct(At);m([p({attribute:!1})],c.prototype,"adapter",2);m([p({attribute:"file-upload"})],c.prototype,"fileUpload",2);m([p({attribute:"voice-input"})],c.prototype,"voiceInput",2);m([p()],c.prototype,"placeholder",2);m([p({attribute:!1})],c.prototype,"suggestions",2);m([p({type:Boolean,attribute:"show-expand-button"})],c.prototype,"showExpandButton",2);m([p({type:Boolean,attribute:"show-minimize-button"})],c.prototype,"showMinimizeButton",2);m([p({type:Boolean})],c.prototype,"expanded",2);m([p({attribute:"minimize-icon"})],c.prototype,"minimizeIcon",2);m([p({type:Boolean,attribute:"enable-reactions"})],c.prototype,"enableReactions",2);m([p({type:Object,attribute:!1})],c.prototype,"agentInfo",2);m([p()],c.prototype,"titleText",2);m([p({attribute:"heading-level",type:Number})],c.prototype,"headingLevel",2);c=m([wt(Et)],c);
