<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AG-UI Chatbot - Backend Communication Test</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
      }
      .config {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .config label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }
      .config input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .config button {
        margin-top: 12px;
        padding: 10px 20px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }
      .config button:hover {
        background: #0052a3;
      }
      .config button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .button-group {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .chatbot-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        height: 600px;
        overflow: hidden;
      }
      .status {
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-size: 14px;
      }
      .status.info {
        background: #e3f2fd;
        color: #0d47a1;
      }
      .status.error {
        background: #ffebee;
        color: #c62828;
      }
      .status.success {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .debug {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        border-left: 3px solid #0066cc;
      }
      .debug pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>AG-UI Chatbot - Backend Communication Test</h1>

      <div class="config">
        <h2>Configuration</h2>
        <div>
          <label for="baseUrl">Base URL:</label>
          <input
            type="text"
            id="baseUrl"
            value="http://localhost:3001/api/agents"
            placeholder="http://localhost:3001/api/agents" />
        </div>
        <div style="margin-top: 12px">
          <label for="agentId">Agent ID:</label>
          <input
            type="text"
            id="agentId"
            value="agent-9b3ff935-f32d-477b-ac45-ce2a3570b90c"
            placeholder="agent-9b3ff935-f32d-477b-ac45-ce2a3570b90c" />
        </div>
        <div class="button-group">
          <button id="testBtn">Test Connection</button>
          <button id="initBtn" disabled>Initialize Chatbot</button>
        </div>
      </div>

      <div id="debug"></div>
      <div id="status"></div>

      <div class="chatbot-container">
        <forge-ai-chatbot
          id="chatbot"
          placeholder="Ask me anything..."
          enable-file-upload>
        </forge-ai-chatbot>
      </div>
    </div>

    <script type="module">
      import { AgUiAdapter, generateId } from './src/lib/ai-chatbot';

      const chatbot = document.getElementById('chatbot');
      const testBtn = document.getElementById('testBtn');
      const initBtn = document.getElementById('initBtn');
      const statusEl = document.getElementById('status');
      const debugEl = document.getElementById('debug');
      const baseUrlInput = document.getElementById('baseUrl');
      const agentIdInput = document.getElementById('agentId');

      function showStatus(message, type = 'info') {
        statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function showDebug(data) {
        debugEl.innerHTML = `<div class="debug"><strong>Debug Info:</strong><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
      }

      function clearStatus() {
        statusEl.innerHTML = '';
      }

      function clearDebug() {
        debugEl.innerHTML = '';
      }

      const tools = [
        {
          name: 'showConfetti',
          description: 'Show a confetti animation to celebrate',
          parameters: {
            type: 'object',
            properties: {
              particleCount: { type: 'number', description: 'Number of particles (default: 100)' },
              spread: { type: 'number', description: 'Spread angle in degrees (default: 70)' }
            }
          }
        }
      ];

      testBtn.addEventListener('click', async () => {
        const baseUrl = baseUrlInput.value.trim();
        const agentId = agentIdInput.value.trim();

        if (!baseUrl || !agentId) {
          showStatus('Please provide both Base URL and Agent ID', 'error');
          return;
        }

        const testUrl = `${baseUrl}/${agentId}/ag-ui`;
        showStatus(`Testing connection to: ${testUrl}`, 'info');

        try {
          const optionsResponse = await fetch(testUrl, {
            method: 'OPTIONS',
            headers: { 'Content-Type': 'application/json' }
          });

          console.log('OPTIONS response:', {
            status: optionsResponse.status,
            headers: Object.fromEntries([...optionsResponse.headers.entries()])
          });

          const postResponse = await fetch(testUrl, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              runId: 'test-run-' + Date.now(),
              threadId: 'test-thread-' + Date.now(),
              messages: [{ role: 'user', content: 'Hello, this is a connection test' }],
              tools: [],
              context: []
            })
          });

          console.log('POST response:', {
            status: postResponse.status,
            headers: Object.fromEntries([...postResponse.headers.entries()])
          });

          const debug = {
            endpoint: testUrl,
            optionsStatus: optionsResponse.status,
            postStatus: postResponse.status,
            corsHeaders: {
              'access-control-allow-origin': optionsResponse.headers.get('access-control-allow-origin'),
              'access-control-allow-credentials': optionsResponse.headers.get('access-control-allow-credentials'),
            },
            contentType: postResponse.headers.get('content-type')
          };

          showDebug(debug);

          if (postResponse.ok && postResponse.headers.get('content-type')?.includes('event-stream')) {
            showStatus('âœ… Connection successful! Backend is responding correctly.', 'success');
            initBtn.disabled = false;
          } else {
            showStatus(`âš ï¸ Unexpected response: ${postResponse.status} ${postResponse.statusText}`, 'error');
          }
        } catch (error) {
          console.error('Connection test failed:', error);
          showStatus(`âŒ Connection failed: ${error.message}`, 'error');
          showDebug({ error: error.message, stack: error.stack });
        }
      });

      initBtn.addEventListener('click', () => {
        const baseUrl = baseUrlInput.value.trim();
        const agentId = agentIdInput.value.trim();

        try {
          const adapter = new AgUiAdapter({
            baseUrl,
            agentId,
            credentials: 'include',
            context: {
              pageUrl: window.location.href,
              userAgent: navigator.userAgent,
              timestamp: new Date().toISOString()
            }
          }, generateId('thread'));

          chatbot.adapter = adapter;
          chatbot.tools = tools;
          chatbot.suggestions = [
            { text: 'What can you help me with?' },
            { text: 'Show me confetti!' }
          ];

          clearDebug();
          showStatus('âœ… Chatbot initialized! Try sending a message.', 'success');
          initBtn.disabled = true;
          testBtn.disabled = true;
          baseUrlInput.disabled = true;
          agentIdInput.disabled = true;

          chatbot.addEventListener('forge-ai-chatbot-message-sent', e => {
            console.log('ðŸ“¤ Message sent:', e.detail);
          });

          chatbot.addEventListener('forge-ai-chatbot-message-received', e => {
            console.log('ðŸ“¥ Message received:', e.detail);
          });

          chatbot.addEventListener('forge-ai-chatbot-error', e => {
            console.error('âŒ Chatbot error:', e.detail);
            showStatus(`Error: ${e.detail.error}`, 'error');
          });

          chatbot.addEventListener('forge-ai-chatbot-tool-call', async e => {
            const { toolCallId, toolName, arguments: args, respond } = e.detail;
            console.log('ðŸ”§ Tool call:', { toolCallId, toolName, args });

            if (toolName === 'showConfetti') {
              confetti({
                particleCount: args?.particleCount || 100,
                spread: args?.spread || 70,
                origin: { y: 0.6 }
              });

              await respond({
                success: true,
                message: `Confetti shown with ${args?.particleCount || 100} particles!`
              });
            }
          });
        } catch (error) {
          console.error('Initialization error:', error);
          showStatus(`Initialization failed: ${error.message}`, 'error');
        }
      });

      showStatus('Click "Test Connection" to verify backend is accessible', 'info');
    </script>
  </body>
</html>
