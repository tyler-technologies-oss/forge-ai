@use '@tylertech/forge/sass/core/styles/spacing' as forge-spacing;
@use '@tylertech/forge/sass/core/styles/shape' as forge-shape;
@use '@tylertech/forge/sass/core/styles/theme' as forge-theme;
@use '@tylertech/forge/sass/typography' as forge-typography;
@use '@tylertech/forge/dist/icon-button/forge-icon-button';

$cursor-blink-duration: 1s;
$fade-distance: 3ch;

:host {
  display: block;
  box-sizing: border-box;
}

:host(:state(empty)) {
  display: none;
}

.assistant-response {
  position: relative;
  margin-inline-end: #{forge-spacing.variable(xxlarge)};

  // Add extra margin after last chatbot tool call if not followed by text chunk
  > forge-ai-chatbot-tool-call:last-of-type:not(:has(+ .text-chunk)) {
    margin-block-end: #{forge-spacing.variable(large)};
  }
}

.text-chunk {
  @include forge-typography.style(body1);
  color: #{forge-theme.variable(on-surface)};
  overflow-wrap: break-word;

  // Markdown formatting style overrides

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    margin: 1.75rem 0 #{forge-spacing.variable(small)};
  }

  strong {
    font-weight: 500;
  }

  a {
    color: #{forge-theme.variable(primary)};
  }

  hr {
    border: none;
    border-top: 1px solid #{forge-theme.variable(outline)};
  }

  code {
    color: #{forge-theme.variable(on-surface-container-low)};
    background-color: #{forge-theme.variable(surface-container-low)};
    border-radius: #{forge-shape.variable(medium)};
    padding: #{forge-spacing.variable(xxxsmall)} #{forge-spacing.variable(xxsmall)};
    font-size: 0.75rem;
  }

  pre {
    border: 1px solid #{forge-theme.variable(outline)};
    border-radius: #{forge-shape.variable(medium)};
    margin-block: #{forge-spacing.variable(medium)} 0;

    code {
      display: block;
      padding: #{forge-spacing.variable(xsmall)} #{forge-spacing.variable(small)};
      color: #{forge-theme.variable(on-surface-container-minimum)};
      background: #{forge-theme.variable(surface-container-minimum)};
      overflow-x: auto;
    }
  }

  > p:has(+ ol),
  > p:has(+ ul) {
    margin-block-end: #{forge-spacing.variable(small)};
  }

  > ul {
    list-style-type: disc;
    padding-inline-start: 1.6875rem;
  }

  > ol {
    padding-inline-start: 1.75rem;
  }

  > ol,
  > ul {
    margin: #{forge-spacing.variable(xsmall)} 0;
    margin-block-end: #{forge-spacing.variable(medium)};
  }

  > :first-child {
    margin-block-start: 0;
  }

  > p {
    margin-block-end: #{forge-spacing.variable(medium)};
    overflow-wrap: anywhere;
    line-height: 1.5;
  }

  &.revealing {
    mask-image: linear-gradient(to left, transparent 0%, black $fade-distance);
    mask-position: right;
    mask-size: 100% 100%;
  }
}

.text-chunk.show-cursor > :last-child::after {
  content: '';
  display: inline-block;
  width: 3px;
  height: 1.2em;
  background-color: #{forge-theme.variable(primary)};
  margin-inline-start: 2px;
  vertical-align: text-bottom;
  border-radius: 1px;
  animation: cursor-blink $cursor-blink-duration step-end infinite;
}

@keyframes cursor-blink {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0;
  }
}

@media (prefers-reduced-motion: reduce) {
  .text-chunk.show-cursor > :last-child::after {
    animation: none;
  }

  .text-chunk.revealing {
    mask-image: none;
  }
}

.toolbar-container {
  position: absolute;
  bottom: -28px;
  left: 0;
  transition:
    opacity 200ms ease-in-out,
    transform 200ms ease-in-out;
  display: flex;
  gap: #{forge-spacing.variable(xxsmall)};
  opacity: 0;
  transform: translateY(-8px);
  pointer-events: none;
  z-index: 1;
}

// Show toolbar on hover or focus within
.assistant-response[data-complete]:hover .toolbar-container,
.assistant-response[data-complete] .toolbar-container:focus-within {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

// Hover bridge to maintain hover state when moving mouse to toolbar (not needed for last response)
:host(:not(:last-of-type)) .assistant-response[data-complete]::after {
  content: '';
  position: absolute;
  bottom: -40px;
  left: 0;
  right: 0;
  height: 40px;
}

// Always show toolbar for last response
:host(:last-of-type) .assistant-response[data-complete] .toolbar-container {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.debug-button {
  color: #{forge-theme.variable(on-error-container-low)};
  --forge-icon-button-focus-indicator-color: #{forge-theme.variable(error)};
  --forge-icon-button-tonal-background-color: #{forge-theme.variable(error-container-low)};
}
