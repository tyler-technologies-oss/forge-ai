const e=3e5;async function t(t){const{agentId:a,baseUrl:n,credentials:o="include",headers:r={}}=t;if(!a)return{isAuthenticated:!0};const i=await fetch(`${n}/api/agents/${a}/auth-config`,{credentials:o,headers:r});if(!i.ok)throw new Error(`Failed to fetch auth config: ${i.statusText}`);if(!(await i.json()).authEnabled)return{isAuthenticated:!0};const s=await fetch(`${n}/api/agents/${a}/auth-status`,{credentials:o,headers:r});if(!s.ok)throw new Error(`Failed to fetch auth status: ${s.statusText}`);const d=await s.json();return d.isAuthenticated?d:await async function(t){const{agentId:a,baseUrl:n}=t,o=500,r=600,i=window.screenX+(window.outerWidth-o)/2,s=window.screenY+(window.outerHeight-r)/2,d=window.open(`${n}/auth/agent/${a}/login`,"tyler-ai-auth",`width=${o},height=${r},left=${i},top=${s}`);if(!d)throw new Error("Failed to open authentication popup. Please allow popups for this site.");return await async function(t,a){const{agentId:n,baseUrl:o,credentials:r="include",headers:i={}}=t,s=Date.now();return new Promise((t,d)=>{const l=setInterval(async()=>{if(a.closed)return clearInterval(l),void d(new Error("Authentication cancelled by user"));if(Date.now()-s>e)return clearInterval(l),a.close(),void d(new Error("Authentication timeout"));try{const e=await fetch(`${o}/api/agents/${n}/auth-status`,{credentials:r,headers:i});if(!e.ok)return;const s=await e.json();s.isAuthenticated&&(clearInterval(l),a.close(),t(s))}catch{}},1e3)})}(t,d)}(t)}function a(){return"loading"===document.readyState?new Promise(e=>{document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})}):Promise.resolve()}function n(e){return"string"==typeof e?document.querySelector(e):e}function o(e){const{baseUrl:t,agentId:a,threadId:n,headers:o={},credentials:r="include"}=e;return async({file:e,onAbort:i,updateProgress:s,markComplete:d,markError:l})=>{const c=new AbortController;i(()=>{c.abort()});const u=new FormData;u.append("file",e);const p=`${t}/api/agents/${a}/threads/${n}/upload`,h=await fetch(p,{method:"POST",body:u,credentials:r,headers:o,signal:c.signal});if(!h.ok){const e=await h.json().catch(()=>({}));throw new Error(e.error||`Upload failed: ${h.statusText}`)}const f=h.body?.getReader();if(!f)throw new Error("Upload failed: No response body");const g=new TextDecoder;let m="";for(;;){const{done:e,value:t}=await f.read();if(e)break;m+=g.decode(t,{stream:!0});const a=m.split("\n");m=a.pop()||"";for(const n of a)if(n.startsWith("data: ")){const e=JSON.parse(n.slice(6));switch(e.type){case"progress":s(e.progress);break;case"complete":return void d({fileId:e.file.file_id,fileName:e.file.file_metadata.fileName,fileType:e.file.file_metadata.fileType,fileSize:e.file.file_metadata.fileSize,uploadedAt:e.file.file_metadata.uploadedAt});case"error":return void l(e.error)}}}}}function r(e,t){const a=new e({url:`${t.baseUrl}/api/agents/${t.agentId}/ag-ui`,headers:t.headers});return t.fileUploadHandler&&a.onFileUpload(t.fileUploadHandler),a}function i(e){const t=document.createElement("forge-ai-chatbot");return t.adapter=e.adapter,t.fileUpload=e.fileUpload??"off",t.placeholder=e.placeholder??"Ask a question...",t.suggestions=e.suggestions,t.voiceInput=e.voiceInput??"on",t}function s(e){if(e.name||e.description||e.version||e.model?.model||e.id||e.metadata?.updatedAt)return{name:e.name,description:e.description,identifier:e.id,version:e.version,model:e.model?.model,lastUpdated:e.metadata?.updatedAt}}function d(e,t,a,n){return{async sendMessage(t,a){await e.sendMessage(t,a)},clearMessages(){e.clearMessages()},getMessages:()=>e.getMessages(),adapter:a,agentRunner:n,element:t,destroy(){a.disconnect(),t.remove()}}}function l(e){return{show(){e.show()},close(){e.close()},toggle(){e.toggle()},get open(){return e.open}}}async function c(e,t){const{chatViewType:c="floating"}=e;switch(c){case"floating":return await async function(e,t){const[a,n,{AgUiAdapter:c,AgentRunner:u}]=await Promise.all([import("./floating-chat.js").then(e=>e.p),import("./floating-chat.js").then(e=>e.q),import("./index.js")]),p=r(c,{baseUrl:e.baseUrl,agentId:e.agentId,headers:e.headers,fileUploadHandler:e.fileUploadHandler}),h=i({adapter:p,fileUpload:t.chatExperience?.enableFileUpload?"on":"off",suggestions:t.chatExperience?.sampleQuestions?.map(e=>({text:e,value:e}))}),f=s(t);f&&(h.agentInfo=f);const g=document.createElement("forge-ai-floating-chat");if(g.appendChild(h),g.open=e.initialOpen??!1,document.body.appendChild(g),t.chatExperience?.enableFileUpload){const t=o({baseUrl:e.baseUrl,agentId:e.agentId,threadId:p.threadId,headers:e.headers,credentials:"include"});p.onFileUpload(t)}let m;!1!==e.showTriggerButton&&(m=function(e){const t=document.createElement("forge-ai-fab");return t.style.position="absolute",t.style.bottom="16px",t.style.right="16px",t.style.zIndex="1000",t.style.display=e.open?"none":"block",t.addEventListener("click",()=>{e.toggle()}),e.addEventListener("forge-ai-floating-chat-open",()=>{t.style.display="none"}),e.addEventListener("forge-ai-floating-chat-close",()=>{t.style.display="block"}),t}(g),document.body.appendChild(m));return{...d(h,g,p,u),...l(g),fabElement:m,destroy(){p.disconnect(),g.remove(),m?.remove()}}}(e,t);case"sidebar":return await async function(e,t){if(!e.mountPoint)throw new Error("mountPoint is required for sidebar chat");await a();const c=n(e.mountPoint);if(!c)throw new Error(`Mount point not found: ${e.mountPoint}`);const[u,{AgUiAdapter:p,AgentRunner:h}]=await Promise.all([import("./sidebar-chat.js"),import("./index.js")]),f=r(p,{baseUrl:e.baseUrl,agentId:e.agentId,headers:e.headers,fileUploadHandler:e.fileUploadHandler}),g=i({adapter:f,fileUpload:t.chatExperience?.enableFileUpload?"on":"off",suggestions:t.chatExperience?.sampleQuestions?.map(e=>({text:e,value:e}))}),m=s(t);m&&(g.agentInfo=m);const w=document.createElement("forge-ai-sidebar-chat");if(w.appendChild(g),w.open=!0,c.appendChild(w),t.chatExperience?.enableFileUpload){const t=o({baseUrl:e.baseUrl,agentId:e.agentId,threadId:f.threadId,headers:e.headers,credentials:"include"});f.onFileUpload(t)}return{...d(g,w,f,h),...l(w)}}(e,t);case"threads":return await async function(e,t){if(!e.mountPoint)throw new Error("mountPoint is required for threads chat");await a();const l=n(e.mountPoint);if(!l)throw new Error(`Mount point not found: ${e.mountPoint}`);const[c,{AgUiAdapter:u,AgentRunner:p}]=await Promise.all([import("./threads-chat.js"),import("./index.js")]),h=r(u,{baseUrl:e.baseUrl,agentId:e.agentId,headers:e.headers,fileUploadHandler:e.fileUploadHandler}),f=i({adapter:h,fileUpload:t.chatExperience?.enableFileUpload?"on":"off",suggestions:t.chatExperience?.sampleQuestions?.map(e=>({text:e,value:e}))}),g=s(t);g&&(f.agentInfo=g);f.showExpandButton=!0;const m=document.createElement("forge-ai-threads");if(m.appendChild(f),l.appendChild(m),t.chatExperience?.enableFileUpload){const t=o({baseUrl:e.baseUrl,agentId:e.agentId,threadId:h.threadId,headers:e.headers,credentials:"include"});h.onFileUpload(t)}return{...d(f,m,h,p)}}(e,t);default:throw new Error(`Unknown chat view type: ${c}`)}}async function u(e){try{if(!e.baseUrl)throw new Error("baseUrl is required");if(!e.agentId&&!e.teamId)throw new Error("Either agentId or teamId is required");if(!(await async function(){return new Promise(e=>{const t=document.createElement("iframe");t.style.display="none",t.src="about:blank";const a=setTimeout(()=>{n(),e(!1)},3e3),n=()=>{clearTimeout(a),t.remove()};t.onload=()=>{try{if(!t.contentDocument&&!t.contentWindow?.document)return n(),void e(!1);document.cookie="tyler_ai_cookie_test=1; SameSite=None; Secure";const a=document.cookie.includes("tyler_ai_cookie_test=1");document.cookie="tyler_ai_cookie_test=; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=None; Secure",n(),e(a)}catch{n(),e(!1)}},document.body.appendChild(t)})}())){const t=new Error("Third-party cookies are disabled. Please enable cookies in your browser settings to use the Tyler AI chatbot.");throw console.error(t),e.onError?.(t),t}const a=await t(e),n=await async function(e,t){const{agentId:a,teamId:n,baseUrl:o,credentials:r="include",headers:i={}}=e,s=n?`${o}/api/team/${n}/team_ui_config`:`${o}/api/configurable-agents/${a}/agent_ui_config`,d=localStorage.getItem("authToken"),l={...i};d&&(l.Authorization=`Bearer ${d}`);try{const e=await fetch(s,{credentials:r,headers:l});if(!e.ok)return console.error(`Failed to fetch agent config: ${e.statusText}`),{};const a=await e.json();return a.chatExperience?.welcomeMessage&&t.userDetails&&(a.chatExperience.welcomeMessage=(c=a.chatExperience.welcomeMessage,(u=t.userDetails)?c.replace(/\{\{id\}\}/g,u.id).replace(/\{\{email\}\}/g,u.email).replace(/\{\{name\}\}/g,u.name):c)),a}catch(p){return console.error("Failed to load agent config:",p),{}}var c,u}(e,a),o=await c(e,n);return window.dispatchEvent(new CustomEvent("tyler-ai-chatbot-ready",{detail:{api:o}})),e.onReady?.(o),o}catch(a){const t=a instanceof Error?a:new Error(String(a));throw console.error("Failed to initialize Tyler AI chatbot:",t),e.onError?.(t),t}}export{u as initChatbot};
